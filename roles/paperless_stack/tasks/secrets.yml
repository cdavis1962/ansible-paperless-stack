---
- name: Define controller-local secrets paths
  ansible.builtin.set_fact:
    #paperless_secrets_dir: "{{ lookup('env','HOME') }}/.ansible/secrets"
    paperless_secrets_dir: "{{ playbook_dir }}/.secrets"
    paperless_dbpass_file: "{{ playbook_dir }}/.secrets/{{ inventory_hostname }}.paperless.dbpass"

- name: Ensure controller secrets directory exists
  delegate_to: localhost
  ansible.builtin.file:
    path: "{{ paperless_secrets_dir }}"
    state: directory
    mode: "0700"

- name: Load or generate persistent DB password (stored on controller)
  ansible.builtin.set_fact:
    paperless_db_pass: >-
      {{ lookup(
           'ansible.builtin.password',
           paperless_dbpass_file,
           length=24,
           chars=['ascii_letters','digits']
         )
      }}

# Optional: write secrets.yml on the target for reference/backups
- name: Write secrets.yml on target
  ansible.builtin.copy:
    dest: "{{ paperless_stack_dir }}/secrets.yml"
    mode: "0600"
    content: |
      paperless_db_pass: "{{ paperless_db_pass }}"
